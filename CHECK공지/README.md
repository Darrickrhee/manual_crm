## CHECK공지

**공지관리 - CHECK공지** 기능은 CHECK를 사용 중인 고객에게 '팝업(popup)' 형태의 공지를 띄우고, 관리하기 위한 기능이다.

CS형이라 불리는 비인터넷공지와 Web형이라 불리는 인터넷공지가 있는데, 인터넷공지의 경우 인터넷이 연결되지 않는 환경에서 CHECK를 이용하는 고객들은 *볼 수 없다*.

따라서 장 시간 변경, 장애 등 중요한 내용을 공지할 때는 **CS형(텍스트 위주)** 을 주로 이용하고, 신규 화면 홍보, 설문조사 등의 부가적인 내용일 경우엔 **Web형(이미지 위주)** 공지를 주로 이용한다.

- 공지 기능의 주 이용자는 정보사업실, 정보업무팀 콘텐츠 담당 직원들이며, CS형 공지는 대체로 담당 직원이 직접 등록한다.

- Web형 공지의 경우 원하는 이미지 파일과 게시기간을 사내메일로 crm 담당자에게 전송하면 crm 담당자가 작업하여 게시해 주는 형태로 작업한다.

- 현재 Web형 공지는 BICNS 에서 전담하여 처리하고 있으므로 요청이 오면 확인 후 전달한다.


팝업은 보통 CHECK 실행시 바로 뜨는데, (특히 Web형 공지에서) 엑박이 뜨는 등 정상적으로 로드되지 않으면 CHECK 고객 입장에서는 **<u>CHECK 품질 자체가 떨어지는 것으로 인식</u>** 하게 된다. 팝업 자체를 띄우는 것은 간단한 작업이지만 신경 써서 작업하고 정상적으로 뜨는지 여부도 항상 확인하는 것이 좋다.

종종 팝업에 입력폼이 있어도 응답할 수 없다고 연락이 오는 경우가 있는데, 대체로는 **IE10 이하의 구버전 브라우저** 를 쓰고 있는 것이 원인인 경우가 많다. 이런 고객은 IE11 이상으로 업그레이드 할 것을 권장한다.

---

### 기능의 동작 흐름은 다음과 같다.  

1. **CHECK공지** 게시판에 공지의 내용을 등록한다.

2. 게시글의 내용과 더불어 공지를 띄우기 위한 **기본 설정 정보** 들이 `kc_crm` 과 `hdb` 에 저장된다.

3. CHECK client 의 **공지 처리 프로그램**이 `hdb` 에 등록된 공지 정보를 바탕으로 공지 팝업을 생성한다.

4. 공지 대상으로 설정된 고객에게 공지 팝업을 띄운다.
    - 보통 PID를 기준으로 공지 대상을 설정한다.

---

### 등록 및 수정 방법은 다음과 같다.

1. 관리자 ID로 로그인 한 뒤 **공지관리 - CHECK공지** 메뉴로 이동한다.

2. '등록' 버튼을 클릭한다.

3. 필요한 항목들을 입력하고 '다음' 버튼을 클릭한다.
    - 공지타입: 앞서 설명했던 Web형 또는 CS형 공지를 목적에 맞게 선택한다.
        - 인터넷공지(WEB): CHECK 사용 환경에서 일반적인 인터넷이 되는 고객들만 볼 수 있다.
        - 비인터넷공지(CS): CHECK를 사용하는 모든 고객이 볼 수 있다.
        
    - 분류
        - ~~게시물: *사용하지 않는 옵션*~~
        - 신규: **CS형 공지**일 경우 무조건 '신규'로 선택하고 에디터에 내용 작성.
        - 직접입력: **Web형 공지**일 경우 <u>무조건 '직접입력'</u>으로 선택하고 URL을 작성.
            > URL은 `http://crm.koscom.co.kr/bos/crm/ext/kscNtc_20190222.do?wsize=690_100_400_420` 와 같은 형태로 등록한다.  

            > `wsize=left_top_width_height` (단위는 px) 파라미터 작성은 <u>필수</u>이다.  
            > (CHECK client의 runpopup.exe 에서 실제로 팝업을 띄워줄 때 **팝업 위치 및 크기**를 설정하기 위해 이용한다.)

    - 공지주기
        - 일회: 특정 시점에 한 번만 띄우고 더이상 팝업을 띄우지 않음.
            > 공지가 뜨는 시점에 CHECK client가 실행되어 있지 않았다면 공지 팝업을 볼 수 없다
        - 주기반복: 정해진 기간동안 정해진 시간에 반복적으로 팝업을 띄움.
        - 로그인시: 정해진 기간동안 CHECK client를 종료했다가 다시 접속할 때마다 팝업을 띄움.
            > CHECK client 프로그램은 매일 오전 - 6시? - 에 재기동 되기 때문에 매일 아침에 팝업이 다시 뜬다고 볼 수 있다.
    - 공지기간: '공지주기'='주기반복'or'로그인시'일 때 사용, 공지가 유효한 기간
    - 공지시간: '공지주기'='주기반복'일 때 사용, 하루 중 공지가 뜰 시간 (24시간 체계로 작성)
    - 공지즉시여부: '공지주기'를 '일회'로 세팅했을 때 사용
        - 시간공지: 공지를 띄울 공지기간(날짜, 하루만 지정 가능)과 공지시간을 설정
        - 즉시공지: 공지 게시글이 저장되는 시점에 바로 공지가 뜸
    - 공지유지시간: 공지 팝업이 화면에 떠있는 시간, 1시간 5분으로 지정하고자 하면 0105라고 입력
    - 제목: 공지 제목, 고객에게는 노출되지 않음
    - 작성자: 로그인한 직원으로 자동 표시됨, 고객에게는 노출되지 않음
    - 내용: '비인터넷공지(CS)'-'신규' 공지일 때 작성함. 공지 내용.
        > 내용 작성을 위해 이용되는 에디터는 **CKEditor** 라는 오픈소스 무료 에디터이며, WYSIWYG로 작성시 적용한 스타일이 CHECK 고객에게도 그대로 공지로 보이게 된다.

    ![img](img/enroll_check_notice_1.png)

4. 공지할 대상을 설정한 뒤 '다음'을 클릭한다.  

    공지는 기본적으로 '전체'가 아니라면 **지정된 PID들**을 대상으로 띄워진다. 이때 PID 선택 기준으로 사용할 수 있는 조건은 아래와 같다.

    - 전체PID: 현재 계약상태가 정상인 모든 PID 대상
    - 업권/업무 _`(사용 시 주의)`_:
        - 특정 고객사(기관)에 소속된 PID들
        - 또는 특정 업권으로 분류된 고객사에 소속된 PID들
        - 또는 PID별 주사용자의 업권, 업무, 투자상품 값에 따른 해당 PID들
    - PID선택: 화면 왼쪽에서 검색하여 선택한 후, '추가 ▷' 하여 '선택 대상' textarea 내에 저장된 PID들
        > PID 직접 입력: PID를 일일이 검색해서 넣기 어려운 경우 '선택 대상' textarea 아래쪽에 ,(comma)로 구분된 PID 목록을 입력한 후 '추가하기'를 누르면 '선택 대상'에 추가가 된다.  

        > PID 목록의 길이는 수십~수천건까지도 가능하다.
    - 권한옵션 _`(사용 시 주의)`_: 특정 권한옵션을 가지고 있는 PID들

    - PID제외: 'PID선택'과 같은 방식으로 선택된 PID들만 <u>제외</u>한 나머지 PID들
        > 특히 '경쟁사PID 제외'를 많이 사용한다.  
        > '경쟁사PID' 목록은 view에 **하드코딩** 되어 있다. 수정을 원할 경우 아래 파일을 수정한다.  
        > `WEB-INF/tags/crm/TargetSelect.tag`
        > ```
        > <%-- 20160901 jwahn add. 경쟁사PID 제외 체크박스 클릭 시 --%>
        > $('#rivalExclusion').click(function () {
        >    'CP08200001': {pid: 'CP08200001', company: '블룸버그', user: '이선미'}
        >    ...
        > };
        > ```

    - ~~PID그룹: 구현 중단. 사용금지.~~

    > _`(사용 시 주의)`_ 조건일 경우  
    > 이 선택 조건들은 최초 개발 이후 충분한 테스트가 이루어지지 않아서 <u>정상동작 여부를 알지 못한다</u>.  
    > 이용하고자 한다면 개발 환경에서 미리 다각도로 시험 해볼 것을 권장한다.


5. 등록 전 최종적으로 공지의 설정 정보를 확인한 뒤 '확인' 버튼을 눌러 등록한다.

6. 등록한 공지 팝업이 정상적으로 뜨는지 CHECK 에서 확인한다.

    ![img](img/enroll_check_notice_5.png)

---

### 연관 소스코드 파일의 이름은 다음과 같다.

### **Web형 공지를 위한 이미지 전용 jsp 생성하는 부분**
- 컨트롤러(java): `PollPopupController.java`
    ```
    @RequestMapping("/bos/crm/ext/kscNtc_{popupName}.do")
    public String popupEventControl(ZValueParam zparam, ModelMap model, @PathVariable("popupName") String popupName) throws Exception
    {
        ...
        return "/portal/event/promotion/" + popupName;
    }
    ```
    > 팝업의 좀 더 빠른 처리를 위해 `kscNtc_*` 로 들어오는 request는 https가 아닌 **http** 로 처리되도록 서버에 예외 설정 되어 있다.  
    

    > 기본적인 Web형 공지는 이미지만 잘 띄워주면 되므로 대체로 서비스나 DAO가 필요하지 않다.

    > 만일 입력값을 받아서 저장해야 하는 등 이미지 표시 외에 추가 기능이 필요할 경우엔 같은 컨트롤러 안에 다른 request 로 정의되어 있을 가능성이 크므로 해당 내용을 찾아본다.


- 화면(jsp): `/WEB-INF/jsp/portal/event/promotion/YYYYMMDD.jsp`
    * 보통은 해당 팝업이 뜨기 시작하는 날짜를 jsp 이름으로 생성한다.

### **CHECK공지 게시글 자체를 처리하는 기본적인 컨트롤러 및 화면**

- 컨트롤러(java): `kr/co/unp/bbs/dao/OptionalBBSManageService.java`
    > 만약 여기를 수정해야 한다면 좀 고통스럽다... unp 스타일의 기본 코드에 게시판별 분기를 얼기설기 얽어놔서 소스 수정이 쉽지 않기 때문... 수정할 일이 없길 바랍니다...

- 화면(jsp): `WEB-INF/jsp/bos/bbs/PG0013/*`
    > 등록은 Reg.jsp, 내용 조회는 Read.jsp, 목록은 List.jsp 등이며 '공지사항' 등과 같은 다른 게시판들과 명명방식이 동일하다.
    

끝.