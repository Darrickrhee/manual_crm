# 상품정보 변경 내역 분석하기

## 문의 내용

- 요청자: 신동우 차장
- 문의 내용:
    - 대략 일주일 전 '내부' PID 개수를 확인했을 때 총 291건이 있었음
    - 일주일 사이 신규로 등록한 내부 PID가 3건 더 있음
    - 그래서 오늘 내부 PID가 총 294건이어야 하는데, 총 295건이 있다고 나왔음
    - 파악되지 않은 +1건이 대체 어느 PID인지 파악할 수 있는지?

## 가설 세우기
- 가설1. 기존에 등록되어 있던 내부 PID 중에서 계약상태(CNTRCT_STT_CD)가 '해지' 였던 것이 '정상'으로 바뀌었다.
- 가설2. 기존에 PID구분(PIDSE_CD)이 '일반'이었던 것이 '내부'로 바뀌었다.

CNTRCT_STT_CD와 PIDSE_CD 컬럼은 모두 TN_GOODS 테이블에 존재하는 PID관련 상품 기본 정보로  
`TN_GOODS_CHGHST` 테이블에서 그 변동내역을 확인할 수 있다.


## 찾아가기

TN_GOODS_CHGHST 테이블의 구성을 이해한 뒤, 문의 내용을 바탕으로 가설1에 걸맞는 쿼리를 작성하여 질의해본다.


### 대상 테이블과 컬럼

desc TN_GOODS_CHGHST;

+-------------+--------------+------+-----+---------+----------------+
| Field       | Type         | Null | Key | Default | Extra          |
+-------------+--------------+------+-----+---------+----------------+
| CHGHST_SQ   | int(11)      | NO   | PRI | NULL    | auto_increment |
| TABLE_NM_CD | varchar(5)   | YES  |     | NULL    |                |
| TABLE_SQ    | int(11)      | YES  |     | NULL    |                |
| COLUMN_NM   | varchar(50)  | YES  |     | NULL    |                |
| ORGINL_CN   | varchar(250) | YES  |     | NULL    |                |
| UPDT_CN     | varchar(250) | YES  |     | NULL    |                |
| CHGHY       | varchar(250) | YES  |     | NULL    |                |
| UPDT_ID     | varchar(45)  | YES  |     | NULL    |                |
| REGIST_DT   | datetime     | YES  |     | NULL    |                |
| STATE       | varchar(5)   | YES  |     | NULL    |                |
+-------------+--------------+------+-----+---------+----------------+
10 rows in set (0.00 sec)




select count(*) from TN_GOODS_CHGHST;

select count(*) from TN_GOODS_CHGHST where REGIST_DT between 20190217 and 20190306;





select distinct TABLE_NM_CD from TN_GOODS_CHGHST
select count(*) from TN_GOODS_CHGHST
select * from TN_GOODS_CHGHST
where REGIST_DT between 20190217 and 20190306
and TABLE_NM_CD='GDINF' -- 상품 정보 값을 변경
and COLUMN_NM='cntrctSttCd' -- 계약상태 값을 변경
and ORGINL_CN='002' and UPDT_CN='001' -- 계약상태가 '해지'에서 '정상'으로 변경됨
;

select *
from TN_GOODS
where GOODS_SQ=5392;

+-----------+-------------+----------+-------------+-----------+---------+--------+---------+---------------------+-------+
| CHGHST_SQ | TABLE_NM_CD | TABLE_SQ | COLUMN_NM   | ORGINL_CN | UPDT_CN | CHGHY  | UPDT_ID | REGIST_DT           | STATE |
+-----------+-------------+----------+-------------+-----------+---------+--------+---------+---------------------+-------+
|    639156 | GDINF       |     5392 | cntrctSttCd | 002       | 001     | 수정   | 21001   | 2019-03-04 10:38:09 | U     |
+-----------+-------------+----------+-------------+-----------+---------+--------+---------+---------------------+-------+
1 row in set (0.13 sec)

-- 5392는 우리가 찾는 내부 PID가 아님

select T1.*, T2.PID, T2.CNTRCT_STT_CD, T2.PIDSE_CD -- 계약상태, PID구분
-- select distinct T2.PID
from (
select * from TN_GOODS_CHGHST 
where REGIST_DT between 20190217 and 20190306
and TABLE_NM_CD='GDINF' -- 상품 정보 값을 변경
and COLUMN_NM='cntrctSttCd' -- 계약상태 값을 변경
and ORGINL_CN='002' and UPDT_CN='001' -- 계약상태가 '해지'에서 '정상'으로 변경됨
) as T1 left outer join TN_GOODS T2 on T1.TABLE_SQ=T2.GOODS_SQ
where T2.PIDSE_CD='002'
and T1.CHGHY not like '신규 등록%'
;

+-----------+-------------+----------+-------------+-----------+---------+-------------------------------+---------+---------------------+-------+------------+---------------+----------+
| CHGHST_SQ | TABLE_NM_CD | TABLE_SQ | COLUMN_NM   | ORGINL_CN | UPDT_CN | CHGHY                         | UPDT_ID | REGIST_DT           | STATE | PID        | CNTRCT_STT_CD | PIDSE_CD |
+-----------+-------------+----------+-------------+-----------+---------+-------------------------------+---------+---------------------+-------+------------+---------------+----------+
|    636350 | GDINF       |      144 | cntrctSttCd | 002       | 001     | 본인 요청으로 재사용          | 20930   | 2019-02-22 09:27:30 | U     | KS63500013 | 001           | 002      |
+-----------+-------------+----------+-------------+-----------+---------+-------------------------------+---------+---------------------+-------+------------+---------------+----------+
1 row in set (0.16 sec)

